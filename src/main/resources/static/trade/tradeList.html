
<div class="pagetitle">
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">AnabadA</a></li>
            <li class="breadcrumb-item active">교환</li>
        </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
        <div class="col-lg-12">

            <div class="card">
                <div class="card-body">

                    <div>
                        <label for="tradeType" class="form-label">거래유형 별 분류</label>
                        <select id="tradeType" name="tradeType" class="form-select"
                                aria-label="Default select example">
                            <option value selected>전체</option>
                            <option value="TRADE">바꿔요</option>
                            <option value="REQUEST">원해요</option>
                            <option value="SHARE">드려요</option>
                        </select>
                    </div>

                    <div>
                        <!--                    <div class="col-md-2">-->
                        <label for="categoryName" class="form-label">카테고리 별 분류</label>
                        <div class="col-sm-10">
                            <select id="categoryName" name="categoryName" class="form-select"
                                    aria-label="Default select example">
                            </select>
                        </div>
                    </div>
                    <!-- Table with stripped rows -->
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th scope="col">No</th>
                            <th scope="col">교환구분</th>
                            <th scope="col">카테고리</th>
                            <th scope="col">제목</th>
                            <th scope="col">작성자</th>
                            <th scope="col">작성일</th>
                        </tr>
                        </thead>
                        <tbody id="tradeList">
                        </tbody>
                    </table>
                    <!-- End Table with stripped rows -->

                    <div class="pagination-container">
                        <ul class="pagination"></ul>
                    </div>

                </div>
            </div>

        </div>
    </div>
</section>
<script src="/js/commons.js"></script>
<script>
    $(document).ready(function () {
        fn_init();

        // 카테고리 선택이 변경되었을 때
        $('#categoryName').on('change', function () {
            fn_getTradeList(0); // 선택된 카테고리에 따라서 거래 목록을 다시 불러옴
        })

        // 거래유형 선택이 변경되었을 때
        $('#tradeType').on('change', function () {
            fn_getTradeList(0); // 선택된 거래유형에 따라서 거래 목록을 다시 불러옴
        });
    });
    function fn_init() {
        fn_getCategoryList();
        fn_getTradeList(0);
    }

    function fn_getCategoryList() {
        // JSON 데이터를 가져오는 비동기 요청
        $.ajax({
            url: '/api/v1/categories/active',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                var nullcategory = '<option value selected  >' + "전체" + '</option>';
                $('#categoryName').append(nullcategory);

                var categories = data.categories;
                for (var i = 0; i < categories.length; i++) {
                    var category = categories[i];
                    var categoryItem = '<option value="' + category.name + '">' + category.name + '</option>';

                    $('#categoryName').append(categoryItem);
                }
            },
            error: function () {
                console.log('fail : 카테고리 목록 조회');
            }
        });
    }


    function fn_getTradeList(page) {
        $('#tradeList').empty();

        // 선택된 카테고리와 거래유형
        var categoryName = $('#categoryName').val();
        var tradeType = $('#tradeType').val();

        var param = {
            "page": page,
            "categoryName": categoryName,
            "tradeType": tradeType,
        };

        // URL에 쿼리 문자열을 추가
        var url = '/api/v1/trades?' + $.param(param);
        console.log(url);

        // JSON 데이터를 가져오는 비동기 요청
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken")
            },
            contentType: 'application/json',
            success: function (data) {
                console.log(data);
                var trades = data.trades.content;
                if (trades) {
                    trades.forEach(function (trade) {
                        var classname = trade.tradeType == "TRADE" ? "badge bg-primary" : (trade.tradeType == "REQUEST" ? "badge bg-success" : "badge bg-danger");
                        var text = trade.tradeType === "TRADE" ? "바꿔요" : (trade.tradeType === "REQUEST" ? "원해요" : "드려요");
                        var tradeItem = '<tr class="trade-item table-list" data-trade-id="' + trade.tradeId + '">' +
                            '<th scope="row">' + trade.tradeId + '</th>' +
                            '<td><span class="' + classname + '">' + text + '</span></td>' +
                            '<td>' + trade.categoryName + '</td>' +
                            '<td>' + trade.tradeTitle + '</td>' +
                            '<td>' + trade.nickname + '</td>' +
                            '<td>' + trade.createdDate + '</td>' +
                            '</tr>';
                        $('#tradeList').append(tradeItem);
                    });
                }

                // 페이지네이션 처리
                var totalPages = data.trades.totalPages;
                var currentPage = data.trades.number;
                updatePagination(currentPage, totalPages);
            },
            error: function () {
                console.log('fail : trade 목록 조회');
            }
        });
    }

    function updatePagination(currentPage, totalPages) {
        // Pagination 부분 업데이트
        var paginationContainer = $('.pagination-container ul');
        paginationContainer.empty();

        for (var i = 0; i < totalPages; i++) {
            var pageItem = '<li class="page-item ' + (i === currentPage ? 'active' : '') + '"><a class="page-link" href="#" onclick="fn_getTradeList(' + i + ')">' + (i + 1) + '</a></li>';
            paginationContainer.append(pageItem);
        }
    }
</script>
