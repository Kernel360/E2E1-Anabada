<div class="card">
    <div class="card-body">
        <h5 class="card-title">My Page</h5>

        <!-- Bordered Tabs -->
        <ul class="nav nav-tabs nav-tabs-bordered" id="borderedTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-profile" type="button" role="tab"
                        aria-controls="profile" aria-selected="true" onclick=getMemberInfo()> 개인 정보 수정
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trade-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-trade" type="button" role="tab"
                        aria-controls="trade" aria-selected="false"
                        tabindex="-1">내가 올린 교환
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trade-offer-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-trade-offer" type="button" role="tab" aria-controls="trade-offer"
                        aria-selected="false" tabindex="-1">내가 올린 요청
                </button>
            </li>
        </ul>
        <div class="tab-content pt-2" id="borderedTabContent">
            <div class="tab-pane fade show active" id="bordered-profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card mb-3">
                            <div class="card-body">

                                <!-- General Form Elements -->
                                <form>
                                    <div class="col-12">
                                        <div>
                                            <label for="password" class="col-sm-2 col-form-label"></label>
                                        </div>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                            <input type="password" name="password" class="form-control" id="password"
                                                   placeholder="새로운 비밀번호을 입력해 주세요." autocomplete="current-password">
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label for="birth" class="form-label" id="birth-label"></label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                            <input type="date" name="birth" class="form-control" id="birth">
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label" id="gender-label"></label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-check-lg"></i></span>
                                            <div class="form-control">
                                                <input class="form-check-input" type="radio" name="gender" id="male" value="M"
                                                       style="margin: 5px 10px 0px 10px;">
                                                <label for="male">남자</label>

                                                <input class="form-check-input" type="radio" name="gender" id="female" value="F"
                                                       style="margin: 5px 10px 0px 10px;">
                                                <label for="female">여자</label>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="row mb-3" style="float: right; white-space: nowrap">
                                        <div class="col-sm-10">
                                            <button id="tradeRequestButton" class="btn btn-primary btn-sm"
                                                    onclick=updateMemberInfo()>수정하기</button>
                                        </div>
                                    </div>

                                </form><!-- End General Form Elements -->

                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="bordered-trade" role="tabpanel" aria-labelledby="trade-tab"><div class="row">
                <div class="col-lg-12">

                    <div class="card">
                        <div class="card-body">
                            <!-- Table with stripped rows -->
                            <table class="table align-middle">
                                <thead>
                                <tr>
                                    <th scope="col">No</th>
                                    <th scope="col">교환구분</th>
                                    <th scope="col">카테고리</th>
                                    <th scope="col">제목</th>
                                    <th scope="col">작성일</th>
                                </tr>
                                </thead>
                                <tbody id="tradeList">
                                </tbody>
                            </table>
                            <!-- End Table with stripped rows -->

                        </div>
                    </div>

                </div>
            </div>
            </div>
            <div class="tab-pane fade" id="bordered-trade-offer" role="tabpanel" aria-labelledby="trade-offer-tab">
                Saepe animi et soluta ad odit soluta sunt. Nihil quos omnis animi debitis cumque. Accusantium quibusdam
                perspiciatis qui qui omnis magnam. Officiis accusamus impedit molestias nostrum veniam. Qui amet ipsum
                iure. Dignissimos fuga tempore dolor.
            </div>
        </div><!-- End Bordered Tabs -->

    </div>
</div>

<div class="pagetitle">
</div><!-- End Page Title -->

<section class="section">

</section>
<script src="/js/commons.js"></script>
<script>
    $(document).ready(function () {
        fn_init();
    });

    function fn_init() {
        getMemberInfo(); // 회원 정보 조회
        getTradeListByMember(); // 회원이 올린 교환 조회
        fn_setEvent(); // 이벤트 초기화 함수 호출
    }

    function getMemberInfo() {
        $.ajax({
            url: '/api/v1/members/' + 1,
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                $('#birth').val(data.birth);
                if (data.gender === 'M') {
                    $('input:radio[name=gender][value=male]').prop('checked', true);
                } else if (data.gender === 'female') {
                    $('input:radio[name=gender][value=female]').prop('checked', true);
                }
            },
            error: function () {
                console.log('fail : member 상세 조회');
            }
        });
    }

    function fn_setEvent() {
        // 이메일 형식, 중복, 닉네임 중복 체크
        $('#email').on('blur', function () {
            $("#email-feedback").hide();
            const emailValue = $(this).val().trim();

            isValidEmail(emailValue);

            if (emailValue === "") {
                $("#email-feedback").text("이메일을 입력하세요.");
                $("#email-feedback").show();
                return;
            }
            $.ajax({
                url: '/api/v1/auth/isEmailUnique',
                method: 'POST',
                data: JSON.stringify({email: emailValue}),
                contentType: 'application/json',
                success: function (data) {
                },
                error: function () {
                    $("#email-feedback").text("이미 존재하는 이메일 입니다.");
                    $("#email-feedback").show();
                    $("#email").val("");
                }
            });
        });

        $('#nickname').on('blur', function () {
            $("#nickname-feedback").hide();
            const nicknameValue = $(this).val().trim();
            if (nicknameValue.length != 0 && !(4 <= nicknameValue.length && 10 >= nicknameValue.length)) {
                alert("닉네임은 4자리 ~ 10자리만 가능합니다.");
                $('#nickname').val("");
                return;
            }
            if (nicknameValue === "") {
                $("#nickname-feedback").text("닉네임 입력하세요.");
                $("#nickname-feedback").show();
                return;
            }
            $.ajax({
                url: '/api/v1/auth/isNicknameUnique',
                method: 'POST',
                data: JSON.stringify({nickname: nicknameValue}),
                contentType: 'application/json',
                success: function (data) {
                },
                error: function () {
                    $("#nickname-feedback").text("사용할 수 없는 닉네임 입니다.");
                    $("#nickname-feedback").show();
                    $("#nickname").val("");
                }
            });
        });

        function isValidEmail(email) {
            var regExp = /\w+([-+.]\w+)*@\w+([-.]\w+)*\.[a-zA-Z]{2,4}$/;
            if (!regExp.test(email)) {
                alert("이메일 형식이 아닙니다.");
                $('#email').val("");
                return false;
            }
            return true;
        }
    }

    function getTradeListByMember() {
        // todo : 이후 회원별 교환 검색 추가해야함
        $.ajax({
            url: '/api/v1/trades',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                var trades = data.trades;

                for (var i = 0; i < trades.length; i++) {
                    var trade = trades[i];
                    var tradeItem = '<tr class="trade-item table-list" data-trade-id="' + trade.tradeId + '">' +
                        '<th scope="row">' + trade.tradeId + '</th>' +
                        '<td>' + (trade.tradeType === "TRADE" ? "바꿔요": (trade.tradeType === "REQUEST" ? "받아요" : "드려요"))+ '</td>' +
                        '<td>' + trade.categoryName + '</td>' +
                        '<td>' + trade.tradeTitle + '</td>' +
                        '<td>' + trade.createdDate + '</td>' +
                        '</tr>';
                    $('#tradeList').append(tradeItem);
                }

                $('.trade-item').click(function () {
                    var tradeId = $(this).data('trade-id');
                    authorize('/trade/tradeInfo.html?tradeNo='+tradeId);
                });
            },
            error: function () {
                console.log('fail : trade 목록 조회');
            }
        });
    }

    function getTradeOfferListByMember() {
        $.ajax({
            url: '/api/v1/trade-offers/',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                $('#email-label').text("이메일: " + data.email);
                $('#nickname-label').text("닉네임: " + data.nickname);
                $('#birth-label').text("생년월일: " + data.birth);
                $('#gender-label').text("성별: " + (data.gender === "M" ? "남성" : "여성"));
            },
            error: function () {
                console.log('fail : member 상세 조회');
            }
        });
    }

    function updateMemberInfo() {
        var param = {
            "id" : 1,
            "email"   : $("#email").val(),
            "nickname": $("#nickname").val(),
            "password": $("#password").val(),
            "birth"   : $("#birth").val(),
            "gender"  : $("input[name='gender']:checked").val()
        }
        console.log(param);
        $.ajax({
            url: 'api/v1/members',
            method: 'PUT',
            data: JSON.stringify(param),
            contentType: 'application/json',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                authorize('member/memberInfo.html');
            },
            error: function () {
                console.log('fail : member 상세 조회');
            }
        });
    }

</script>