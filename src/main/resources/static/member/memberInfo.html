<div class="card">
    <div class="card-body">
        <h5 class="card-title">마이페이지</h5>

        <!-- Bordered Tabs -->
        <ul class="nav nav-tabs nav-tabs-bordered" id="borderedTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-profile" type="button" role="tab"
                        aria-controls="profile" aria-selected="true" onclick=fn_getMemberInfo()> 내정보
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trade-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-trade" type="button" role="tab"
                        aria-controls="trade" aria-selected="false"
                        tabindex="-1">내가 올린 교환
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trade-offer-tab" data-bs-toggle="tab"
                        data-bs-target="#bordered-trade-offer" type="button" role="tab" aria-controls="trade-offer"
                        aria-selected="false" tabindex="-1">내가 올린 요청
                </button>
            </li>
        </ul>
        <div class="tab-content pt-3" id="borderedTabContent">
            <div class="tab-pane fade show active" id="bordered-profile" role="tabpanel" aria-labelledby="profile-tab">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">내정보</h5>
                                <div class="col-12">
                                    <div class="input-group has-validation">
                                        <span class="input-group-text"><i class="bi bi bi-at"></i></span>
                                        <input type="text" class="form-control" id="email" readonly>
                                    </div>
                                </div>

                                <br>
                                <h5 class="card-title">개인정보 수정</h5>
                                <!-- General Form Elements -->
                                <form>
                                    <div class="col-12">
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi bi-person-check-fill"></i></span>
                                            <input type="text" class="form-control" id="nickname">
                                            <div id="nickname-feedback" class="invalid-feedback">닉네임을 입력하세요.</div>
                                        </div>
                                    </div>

                                    <br>

                                    <div class="col-12">
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                            <input type="date" name="birth" class="form-control myBirth" id="birth">
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label" id="gender-label"></label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-check-lg"></i></span>
                                            <div class="form-control">
                                                <input class="form-check-input" type="radio" name="gender" id="male" value="M"
                                                       style="margin: 5px 10px 0px 10px;">
                                                <label for="male">남자</label>

                                                <input class="form-check-input" type="radio" name="gender" id="female" value="F"
                                                       style="margin: 5px 10px 0px 10px;">
                                                <label for="female">여자</label>
                                            </div>
                                        </div>
                                    </div>
                                    <br>
                                    <div class="row mb-3" style="float: right; white-space: nowrap">
                                        <div class="col-sm-10">
                                            <button id="memberInfoUpdateButton" class="btn btn-primary btn-sm"> 수정하기</button>
                                        </div>
                                    </div>
                                </form><!-- End General Form Elements -->

                                <br>
                                <h5 class="card-title">비밀번호 수정</h5>
                                <form>
                                    <div class="col-12">
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                            <input type="password" name="password" class="form-control" id="password"
                                                   placeholder="새로운 비밀번호을 입력해 주세요." autocomplete="current-password">
                                            <button id="passwordUpdateButton" class="btn btn-primary btn-sm" >변경</button>
                                        </div>
                                    </div>
                                </form>
                                <br>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="bordered-trade" role="tabpanel" aria-labelledby="trade-tab"><div class="row">
                <div class="col-lg-12">

                    <div class="card">
                        <div class="card-body">
                            <!-- Table with stripped rows -->
                            <table class="table align-middle">
                                <thead>
                                <tr>
                                    <th scope="col">교환구분</th>
                                    <th scope="col">카테고리</th>
                                    <th scope="col">제목</th>
                                    <th scope="col">작성자</th>
                                    <th scope="col">상태</th>
                                    <th scope="col">작성일</th>
                                </tr>
                                </thead>
                                <tbody id="tradeList">
                                </tbody>
                            </table>
                            <!-- End Table with stripped rows -->
                            <div class="row">
                                <div class="pagination-container trade-pagination-container col-md-9">
                                    <ul class="pagination"></ul>
                                </div>
                                <div class="col-md-3" style="text-align: right">
                                    <span class="badge bg-before-accept" style="font-size: 9px; --bs-badge-padding-x: 0.65em !important;--bs-badge-padding-y: 0.3em !important;--bs-badge-border-radius: 100px!important;">&nbsp;</span>
                                    <span style="font-size: 14px;">거래수락</span>
                                    <br>
                                    <span class="badge bg-after-accept" style="font-size: 9px; --bs-badge-padding-x: 0.65em !important;--bs-badge-padding-y: 0.3em !important;--bs-badge-border-radius: 100px!important;">&nbsp;</span>
                                    <span style="font-size: 14px;">거래대기</span>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
            </div>
            <div class="tab-pane fade" id="bordered-trade-offer" role="tabpanel" aria-labelledby="trade-offer-tab">
                <div class="col-lg-12">

                    <div class="card">
                        <div class="card-body">

                            <table class="table align-middle">
                                <thead>
                                <tr>
                                    <th scope="col" style="width: 35%;">교환글제목</th>
                                    <th scope="col" style="width: 35%;">요청제목</th>
                                    <th scope="col" style="width: 10%;">요청상태</th>
                                    <th scope="col" style="width: 20%;">작성일</th>
                                </tr>
                                </thead>
                                <tbody id="tradeOfferList">
                                </tbody>
                            </table>

                            <div class="pagination-container trade-offer-pagination-container col-md-9">
                                <ul class="pagination"></ul>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div><!-- End Bordered Tabs -->

    </div>
</div>

<div class="pagetitle">
</div><!-- End Page Title -->

<section class="section">

</section>
<script src="/js/commons.js"></script>
<script>
    $(document).ready(function () {
        fn_init();
    });

    function fn_init() {
        fn_getMemberInfo(); // 회원 정보 조회
        fn_getTradeListByMember(0); // 회원이 올린 교환 조회
        fn_getTradeOfferListByMember(0) // 회원이 올린 교환 요청 조회
        fn_setEvent(); // 이벤트 초기화 함수 호출

        if (param.tradeOffer == "tradeOffer") {
            $("#trade-offer-tab").click();
        }
    }

    function fn_getMemberInfo() {
        $.ajax({
            url: '/api/v1/members/info',
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                $('#email').val(data.email);
                $('#nickname').val(data.nickname);
                $('#birth').val(data.birth);
                if (data.gender == 'M') {
                    $('input:radio[name=gender][value=M]').prop('checked', true);
                } else if (data.gender == 'F') {
                    $('input:radio[name=gender][value=F]').prop('checked', true);
                }
            },
            error: function (data) {
                alert(data.responseJSON.message);
            }
        });
    }

    function fn_getTradeListByMember(pageNo) {
        $('#tradeList').empty();

        var param = {
            "pageNo": pageNo,
            "createdBy": $("#header-member-nickname").text()
        };

        var url = '/api/v1/trades?' + $.param(param);

        // JSON 데이터를 가져오는 비동기 요청
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken")
            },
            contentType: 'application/json',
            success: function (data) {
                var trades = data.trades.content;
                if (trades) {
                    trades.forEach(function (trade) {
                        var typeClassname = trade.tradeType == "TRADE" ? "badge bg-primary" : (trade.tradeType == "REQUEST" ? "badge bg-success" : "badge bg-danger");

                        var stateClassname = trade.tradeStatus == "BEFORE_ACCEPT" ? "badge bg-before-accept" : "badge bg-after-accept";
                        var text = trade.tradeType === "TRADE" ? "바꿔요" : (trade.tradeType === "REQUEST" ? "원해요" : "드려요");
                        var tradeItem = '<tr class="trade-item table-list" data-trade-id="' + trade.tradeId + '" data-trade-status="'+trade.tradeStatus +'" data-trade-offer-createdby="'+ trade.tradeOfferCreatedBy +'" data-trade-createdby="'+trade.nickname +'">' +
                            '<td><span class="' + typeClassname + '">' + text + '</span></td>' +
                            '<td>' + trade.categoryName + '</td>' +
                            '<td>' + trade.tradeTitle + '</td>' +
                            '<td>' + trade.nickname + '</td>' +
                            '<td><span class="' + stateClassname + '" style="--bs-badge-padding-x: 0.65em !important;--bs-badge-padding-y: 0.3em !important;--bs-badge-border-radius: 100px!important;">&nbsp;</span></td>' +
                            '<td>' + trade.createdDate + '</td>' +
                            '</tr>';

                        $('#tradeList').append(tradeItem);
                    });
                }

                // 페이지네이션 처리
                var totalPages = data.trades.totalPages;
                var currentPage = data.trades.number;
                updateTradePagination(currentPage, totalPages);

                $('.trade-item').click(function () {
                    var tradeId = $(this).data('trade-id');
                    authorize('/trade/tradeInfo.html?tradeId='+tradeId);
                });
            },
            error: function (data) {
                alert(data.responseJSON.message);
            }
        });
    }

    function fn_getTradeOfferListByMember(pageNo) {
        $('#tradeOfferList').empty();
        var param = {
            "pageNo": pageNo,
            "nickname": $("#header-member-nickname").text()
        };
        var url = '/api/v1/trade-offers?' + $.param(param);
        $.ajax({
            url: url,
            method: 'GET',
            dataType: 'json',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
            },
            success: function (data) {
                var tradeOffers = data.tradeOffers.content;

                for (var i = 0; i < tradeOffers.length; i++) {
                    var tradeOffer = tradeOffers[i];
                    var tradeOfferItem = '<tr class="trade-offer-item table-list" data-trade-offer-id="' + tradeOffer.id + '" data-trade-id="' + tradeOffer.tradeId + '" data-trade-title="' + tradeOffer.tradeTitle + '" data-trade-member-nickname="' + tradeOffer.tradeMemberNickname + '">' +
                        '<td>' + tradeOffer.tradeTitle + '</td>' +
                        '<td>' + tradeOffer.title + '</td>' +
                        '<td>' + (tradeOffer.tradeOfferStatus === "REQUEST_ON_HOLD" ? "요청대기": (tradeOffer.tradeOfferStatus === "REQUEST_ACCEPTED" ? "요청수락" : "요청만료"))+ '</td>' +
                        '<td>' + tradeOffer.createdDate + '</td>' +
                        '</tr>';
                    $('#tradeOfferList').append(tradeOfferItem);
                }

                // 페이지네이션 처리
                var totalPages = data.tradeOffers.totalPages;
                var currentPage = data.tradeOffers.number;
                updateTradeOfferPagination(currentPage, totalPages);

                $('.trade-offer-item').click(function () {
                    var json = {
                        "tradeId": $(this).data('trade-id'),
                        "tradeOfferId": $(this).data('trade-offer-id'),
                        "tradeTitle": $(this).data('trade-title'),
                        "nickname": $(this).data('trade-member-nickname')
                    };
                    authorize('/tradeOffer/tradeOfferInfo.html?tradeOfferId=' + json.tradeOfferId + "&tradeTitle=" + json.tradeTitle + "&nickname=" + json.nickname + "&tradeId=" + json.tradeId);
                });
            },
            error: function (data) {
                alert(data.responseJSON.message);
            }
        });
    }

    function updateTradePagination(currentPage, totalPages) {
        // Pagination 부분 업데이트
        var paginationContainer = $('.trade-pagination-container ul');
        paginationContainer.empty();

        var pagesToShow = 10; // 한 번에 보여질 페이지 수
        var startPage = Math.max(1, currentPage+1 - Math.floor(pagesToShow / 2));
        var endPage = Math.min(totalPages, startPage + pagesToShow - 1);

        // 이전 버튼
        paginationContainer.append(
            '<li class="page-item ' + ((currentPage+1) === 1 ? 'disabled' : '') + '">' +
            '<a class="page-link" onclick="fn_getTradeListByMember(' + ((currentPage+1) - 1) + ')">«</a>' +
            '</li>'
        );

        for (var i = startPage; i <= endPage; i++) {
            var pageItem =
                '<li class="page-item ' + (i === (currentPage+1) ? 'active' : '') + '">' +
                '<a class="page-link" onclick="fn_getTradeListByMember(' + i + ')">' + i + '</a>' +
                '</li>';
            paginationContainer.append(pageItem);
        }

        // 다음 버튼
        paginationContainer.append(
            '<li class="page-item ' + ((currentPage+1) === totalPages ? 'disabled' : '') + '">' +
            '<a class="page-link" onclick="fn_getTradeListByMember(' + ((currentPage+1) + 1) + ')">»</a>' +
            '</li>'
        );
    }

    function updateTradeOfferPagination(currentPage, totalPages) {
        // Pagination 부분 업데이트
        var paginationContainer = $('.trade-offer-pagination-container ul');
        paginationContainer.empty();

        var pagesToShow = 10; // 한 번에 보여질 페이지 수
        var startPage = Math.max(1, currentPage+1 - Math.floor(pagesToShow / 2));
        var endPage = Math.min(totalPages, startPage + pagesToShow - 1);

        // 이전 버튼
        paginationContainer.append(
            '<li class="page-item ' + ((currentPage+1) === 1 ? 'disabled' : '') + '">' +
            '<a class="page-link" onclick="fn_getTradeOfferListByMember(' + ((currentPage+1) - 1) + ')">«</a>' +
            '</li>'
        );

        for (var i = startPage; i <= endPage; i++) {
            var pageItem =
                '<li class="page-item ' + (i === (currentPage+1) ? 'active' : '') + '">' +
                '<a class="page-link" onclick="fn_getTradeOfferListByMember(' + i + ')">' + i + '</a>' +
                '</li>';
            paginationContainer.append(pageItem);
        }

        // 다음 버튼
        paginationContainer.append(
            '<li class="page-item ' + ((currentPage+1) === totalPages ? 'disabled' : '') + '">' +
            '<a class="page-link" onclick="fn_getTradeOfferListByMember(' + ((currentPage+1) + 1) + ')">»</a>' +
            '</li>'
        );
    }

    function fn_setEvent() {
        $('#nickname').on('blur', function () {
            $("#nickname-feedback").hide();
            const nicknameValue = $(this).val().trim();
            if (nicknameValue.length!=0 && !(4 <= nicknameValue.length &&  10 >= nicknameValue.length)) {
                alert("닉네임은 4자리 ~ 10자리만 가능합니다.");
                $('#nickname').val("");
                return;
            }
            $.ajax({
                url: '/api/v1/auth/isNicknameUnique',
                method: 'POST',
                data: JSON.stringify({ nickname: nicknameValue }),
                contentType: 'application/json',
                success: function (data) {
                },
                error: function (data) {
                    $("#nickname-feedback").text(data.responseJSON.message);
                    $("#nickname-feedback").show();
                    $("#nickname").val("");
                }
            });
        });

        $('#memberInfoUpdateButton').click(function (e) {
            e.preventDefault()
            var param = {
                "nickname": $("#nickname").val(),
                "birth": $("#birth").val(),
                "gender": $("input[name='gender']:checked").val()
            }
            $.ajax({
                url: 'api/v1/members',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(param),
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
                },
                success: function (data) {
                    alert("회원정보가 수정되었습니다.");
                    $(".member-nickname").text($("#nickname").val());
                },
                error: function (data) {
                    alert(data.responseJSON.message);
                }
            });
        });

        $('#passwordUpdateButton').click(function (e) {
            e.preventDefault()
            if ($("#password").val().trim().length!=0 && !(8 <= $("#password").val().trim().length &&  16 >= $("#password").val().trim().length)) {
                alert("비밀번호는 8자리 ~ 16자리만 가능합니다.");
                return;
            }
            $.ajax({
                url: 'api/v1/members/password',
                method: 'PUT',
                data: JSON.stringify({ "password" : $("#password").val()}),
                contentType: 'application/json',
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("accessToken") // 헤더에 토큰 추가
                },
                success: function (data) {
                    alert("비밀번호가 변경되었습니다.");
                    $("#password").val("");
                },
                error: function(data) {
                    alert(data.responseJSON.message);
                }
            });
        });
    }

</script>